function addFileToList(b){var a="";a='<tr id="'+b.fileId+'">';a+="<td>"+b.fileName+"</td>";a+=" <td>"+b.fileSize+"</td>";a+=" <td>"+b.uploadDate+"</td>";a+='<td><span><a  target="_blank"  href="'+$("#contextPath").val()+"/sys/attach/file/view?fileId="+b.fileId+'">'+$("#pic_btn_view").val()+"</a>";a+='</span>|<span><a href="javascript:void(0)" onclick="rmfile(\''+b.fileId+"')\">"+$("#pic_btn_del").val()+"</a></span></td>";a+="</tr>";$("#attach_list_body").append(a)}jQuery(function(){var g=jQuery,n=g("#uploader"),i=g('<ul class="filelist"></ul>').appendTo(n.find(".queueList")),s=n.find(".statusBar"),c=s.find(".info"),b=n.find(".uploadBtn"),f=n.find(".placeholder"),m=s.find(".progress").hide(),u=0,l=0,j=window.devicePixelRatio||1,k=110*j,a=110*j,h="pedding",v={},r=(function(){var w=document.createElement("p").style,x="transition" in w||"WebkitTransition" in w||"MozTransition" in w||"msTransition" in w||"OTransition" in w;w=null;return x})(),p;if(!WebUploader.Uploader.support()){alert(g("#upload_not_support").val());throw new Error(g("#upload_not_support").val())}p=WebUploader.create({pick:{id:"#filePicker",label:g("#btn_choose_file").val()},dnd:"#uploader .queueList",paste:document.body,accept:null,swf:BASE_URL+"/js/Uploader.swf",disableGlobalDnd:true,chunked:false,server:g("#contextPath").val()+"/sys/attach/upload",fileNumLimit:5,fileSizeLimit:undefined,fileSingleSizeLimit:undefined,formData:{sourceType:g("#sourceType").val(),sourceKey:g("#sourceKey").val()}});p.addButton({id:"#filePicker2",label:g("#btn_con_add").val()});function q(B){var C=g('<li id="'+B.id+'"><p class="title">'+B.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),z=g('<div class="file-panel"><span class="cancel">'+g("#queue_btn_del").val()+'</span><span class="rotateRight">'+g("#btn_rotateright").val()+'</span><span class="rotateLeft">'+g("#btn_rotateleft").val()+"</span></div>").appendTo(C),y=C.find("p.progress span"),x=C.find("p.imgWrap"),A=g('<p class="error"></p>'),w=function(D){switch(D){case"exceed_size":text=g("#single_file_size_max_error").val();break;case"interrupt":text=g("#upload_interrupt").val();break;case"TYPEORKEY_EMPTY":text=g("#typeorkey_empty").val();break;case"FILE_EMPTY_ERROR":text=g("#file_empty_error").val();break;case"FILE_DISALLOWD_ERROR":text=g("#file_disallowd_error").val();break;case"SINGLE_FILE_SIZE_MAX_ERROR":text=g("#single_file_size_max_error").val();break;case"DATABASE_ERROR":text=g("#database_error").val();break;default:text=g("#default_error").val();break}A.text(text).appendTo(C)};if(B.getStatus()==="invalid"){w(B.statusText)}else{x.text(g("#pic_preview").val());p.makeThumb(B,function(E,F){if(E){x.text(g("#pic_cannot_preview").val());return}var D=g('<img src="'+F+'">');x.empty().append(D)},k,a);v[B.id]=[B.size,0];B.rotation=0}B.on("statuschange",function(E,D){if(D==="progress"){y.hide().width(0)}else{if(D==="queued"){C.off("mouseenter mouseleave");z.css("height","0px")}}if(E==="complete"){z.css("height","30px")}if(E==="error"||E==="invalid"){w(B.statusText);v[B.id][1]=1}else{if(E==="interrupt"){w("interrupt")}else{if(E==="queued"){v[B.id][1]=0}else{if(E==="progress"){A.remove();y.css("display","block")}else{if(E==="success"){C.append('<span class="success"></span>')}else{if(E=="TYPEORKEY_EMPTY"&&D=="complete"){w("TYPEORKEY_EMPTY")}else{if(E=="FILE_DISALLOWD_ERROR"&&D=="complete"){w("FILE_DISALLOWD_ERROR")}else{if(E=="FILE_EMPTY_ERROR"&&D=="complete"){w("FILE_EMPTY_ERROR")}else{if(E=="SINGLE_FILE_SIZE_MAX"&&D=="complete"){w("SINGLE_FILE_SIZE_MAX")}else{if(E!="queued"&&E!="process"&&E!="complete"){w(E)}}}}}}}}}}C.removeClass("state-"+D).addClass("state-"+E)});C.on("mouseenter",function(){z.stop().animate({height:30})});C.on("mouseleave",function(){z.stop().animate({height:0})});z.on("click","span",function(){var D=g(this).index(),E;switch(D){case 0:p.removeFile(B);return;case 1:B.rotation+=90;break;case 2:B.rotation-=90;break}if(r){E="rotate("+B.rotation+"deg)";x.css({"-webkit-transform":E,"-mos-transform":E,"-o-transform":E,transform:E})}else{x.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((B.rotation/90)%4+4)%4)+")")}});C.appendTo(i)}function t(w){var x=g("#"+w.id);delete v[w.id];d();x.off().find(".file-panel").off().end().remove()}function d(){var w=0,z=0,x=m.children(),y;g.each(v,function(B,A){z+=A[0];w+=A[0]*A[1]});y=z?w/z:0;x.eq(0).text(Math.round(y*100)+"%");x.eq(1).css("width",Math.round(y*100)+"%");e()}function e(){var x="",w;if(h==="ready"){}else{if(h==="confirm"){w=p.getStats()}else{w=p.getStats()}}c.html(x);b.removeClass("disabled");g("#filePicker2").removeClass("element-invisible")}function o(y){var x,w;if(y===h){return}b.removeClass("state-"+h);b.addClass("state-"+y);h=y;switch(h){case"pedding":f.removeClass("element-invisible");i.parent().removeClass("filled");i.hide();s.addClass("element-invisible");p.refresh();break;case"ready":f.addClass("element-invisible");g("#filePicker2").removeClass("element-invisible");i.parent().addClass("filled");i.show();s.removeClass("element-invisible");p.refresh();break;case"uploading":g("#filePicker2").addClass("element-invisible");m.show();b.text(g("#pause_upload").val());break;case"paused":m.show();b.text(g("#resume_upload").val());break;case"confirm":m.hide();b.text(g("#start_upload").val()).addClass("disabled");w=p.getStats();if(w.successNum&&!w.uploadFailNum){o("finish");return}break;case"finish":w=p.getStats();if(w.successNum){}else{h="done";location.reload()}break}e()}p.onUploadProgress=function(y,w){var z=g("#"+y.id),x=z.find(".progress span");x.css("width",w*100+"%");v[y.id][1]=w;d()};p.onFileQueued=function(w){u++;l+=w.size;if(u===1){f.addClass("element-invisible");s.show()}q(w);o("ready");d()};p.onFileDequeued=function(w){u--;l-=w.size;if(!u){o("pedding")}t(w);d()};p.on("all",function(x){var w;switch(x){case"uploadFinished":o("confirm");break;case"startUpload":o("uploading");break;case"stopUpload":o("paused");break}});p.onError=function(w){if(w=="Q_EXCEED_NUM_LIMIT"){alert(g("#queue_num_not_allowed").val())}else{alert("Error: "+w)}};b.on("click",function(){if(g(this).hasClass("disabled")){return false}if(h==="ready"){p.upload()}else{if(h==="paused"){p.upload()}else{if(h==="uploading"){p.stop()}}}});c.on("click",".retry",function(){p.retry()});c.on("click",".ignore",function(){var x=p.getFiles("error");for(var w=0;w<x.length;w++){p.removeFile(x[w])}});b.addClass("state-"+h);d();p.onUploadError=function(w,x){alert(w.id+g("#default_error").val()+x)};p.onUploadSuccess=function(x,w){if(w.message=="UPLOAD_SUCCESS"){x.setStatus("success");addFileToList(w.file)}else{x.setStatus(w.info)}}});