<#include "../include/header.html">
    <body>
    <script src="${base.contextPath}/resources/js/wfl/wfl.js"></script>
    <script src="${base.contextPath}/lib/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="${base.contextPath}/lib/assets/global/plugins/jquery-ui/jquery-ui.min.js"></script>
    <link href="${base.contextPath}/lib/assets/global/plugins/jquery-ui/jquery-ui.min.css" rel="stylesheet" type="text/css"/>
    <style type="text/css">
        html,body {
            overflow:hidden;
            color:#333;
        }
        .approve-block {
            padding:0px 20px 20px 20px;
        }
        .approve-block h3 {
            font-weight: normal;
            color:#000;
            font-size:16px;
        }

        .approve-block h4 {
            font-weight: normal;
            color:#000;
            font-size:14px;
        }
        .approve-table {
            border-collapse: collapse;
        }
        .approve-table .item-label {
            /*text-align:right;*/
        }
        .approve-table .item-value{
            /*font-weight:bold;*/
        }

        .approve-table td {
            padding:8px;
            font-size:12px;
            border: #e7ecf1 solid 1px;
        }
        #historyTable {
            width:100%;
        }
        #historyTable thead td{
            padding:8px;
            font-weight:bold;
            color:#333;
            font-size:14px;
        }

        #includeFrame {
            border: none !important;
            box-shadow: none;
        }


        #ta-comment {
            padding:10px;
            width: 700px;
            height: 40px;
            border: #e7ecf1 solid 1px;
        }

        .comment-too-long {
            color: red;
        }

        .action_ok {
            color: #5fb760;
        }

        .action_dangerous {
            color: #eeac5f;
        }

        .action_custom {
            color: #60c0dc;
        }

        button:before {
            margin-right: 2px;
        }

        span[class^='fa']:before {
            margin-right: 3px;
        }

        .listView{
            display: inline-block;
            border: 1px solid #66afe9;
            padding: 5px;
            margin-right:5px;
            margin-top:10px;
        }
        .listViewBorder{
            min-height: 52px;
            margin-bottom: 20px;
            margin-top: 5px;
            border: 1px #e0e0e0 solid;
            margin-left: 20px;
            margin-right: 20px;
            padding-bottom: 12px;
            padding-top: 2px;
        }

        #carbonCopy{
            box-shadow:none;
            border: none;
            float: left;
            margin-left:10px
        }

        body .ui-tooltip {
            max-width: 800px;
        }
        .ui-tooltip table{
            width: 90%;
            border-collapse: collapse;
            border:1px solid #c0c0c0;
            font-size: 12px;
        }

        .ui-tooltip table th{
            word-break: keep-all;
            white-space:nowrap;
            padding:5px;
            border:1px solid #c0c0c0;
        }
        .ui-tooltip table td{
            word-break: keep-all;
            white-space:nowrap;
            padding:5px;
            border:1px solid #c0c0c0;
        }

        #tabs .nav {
            margin:10px 0px 20px 0px;
            padding:0;
            display:table;
            width:100%;
            border-bottom: 1px solid #efefef;
        }
        #tabs .nav li {
            float:left;
            list-style-type:none;
        }

        #tabs .nav li a {
            display: inline-block;
            padding: 5px 15px;
            text-decoration: none;
            color: #8478B3;
            border:none;
        }

        #tabs .nav li.active {
            display: inline-block;
            background: 0 0;
            border-bottom: 2px solid #36c6d3 !important;
        }


        #tabs .nav li.active a{
            border:none;
            background:#fff;color: #655c89;outline:none;
        }

        #tabs .nav li:hover{
            display: inline-block;
            background: 0 0;
            border-bottom: 2px solid #9fe4ea !important;
        }

        #tabs .nav li a:hover{
            background:#fff;color: #655c89;outline:none;
            border:none;
        }

    </style>
    <script>
        $(function() {
            $(document).tooltip({
                content: function () {
                    var element = $( this );
                    // 提示纯HTML，可以自定义样式、内容等等
                    return element.attr("title");
                }
            });
            var svgLoad = false;
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                if(parent.autoResizeIframe){
                    parent.autoResizeIframe(_currentFunctionCode)
                }
                if($(e.target).attr("id") == "proImg" && !svgLoad) {
                    processSvg();
                    svgLoad = true;
                }
            });
        });


        var onIncludeFrameLoad = function() {
            var ifm = document.getElementById("includeFrame");
            var subWeb = document.frames ? document.frames["includeFrame"].document : ifm.contentDocument;
            if (ifm != null && subWeb != null) {
                ifm.height = $(subWeb).height();
                ifm.width = subWeb.body.scrollWidth;
                if(parent.autoResizeIframe){
                    parent.autoResizeIframe(_currentFunctionCode)
                }

            }
        }

        var onSvgLoad = function () {
            if(parent.autoResizeIframe){
                parent.autoResizeIframe(_currentFunctionCode)
            }
        }


        var processSvg = function () {

            $.ajax({
                url: "${base.contextPath}/wfl/runtime/process-instances/"+currentTaskInfo.processInstanceId+"/forecast",
                type: "GET",
                success: function (data) {
                    processData(data);
                }
            });
            var processData = function (data){
                var offsetY = $("#processImg").offset().top ;
                var offsetX = $("#processImg").offset().left;
                for(var i = 0;i<data.length;i++){
                    var index = data[i];
                    var grapINfo = index.graphicInfo;
                    var div = $("<div id = "+index.taskId+"></div>");
                    div.css("width",grapINfo.width);
                    div.css("height",grapINfo.height);
                    div.css("position","absolute");
                    //div.css("background","red");
                    div.css("left",grapINfo.x+offsetX);
                    div.css("top",grapINfo.y+offsetY);
                    div.attr("name","svgDiv");

                    var context = "<div style='margin-bottom: 10px;'><strong style='font-size: 16px;'>审批记录</strong></div>"+"<table  >" +
                        "<tr align='center'><th>审批人</th><th>岗位名称</th><th>部门名称</th><th>审批动作</th><th>审批日期</th></tr>";
                    if(index.executed || index.history){
                        var history = index.history ||{};
                        var hisVar = " ";
                        for(var ii = 0;ii<history.length;ii++){
                            var hisInx = history[ii];
                            var action = hisInx.action;
                            if (action == 'APPROVED'){
                                apprvText = "<span class='action_ok'>同意</span>";
                            } else if (action == 'REJECTED'){
                                apprvText = "<span class='action_dangerous'>拒绝</span>";
                            }else if(action == 'ADD_SIGN'){
                                apprvText = "<span class='action_dangerous'>加签</span>";
                            }else if(action == 'DELEGATE'){
                                apprvText = "<span class='action_dangerous'>转交</span>";
                            } else if(action == 'JUMP'){
                                apprvText = "<span class='action_dangerous'>跳转</span>";
                            }else if(action == 'RECALL'){
                                apprvText = "<span class='action_dangerous'>撤回</span>";
                            }else if(action == "AUTO_DELEGATE") {
                                apprvText = "<span class='action_dangerous'>自动转交</span>";
                            }else if(action == "CARBON_COPY") {
                                apprvText = "<span class='action_dangerous'>抄送</span>";
                            }else{
                                apprvText = action || ''
                            }
                            hisInx.assigneeName = hisInx.assigneeName ||"";
                            hisInx.positionName = hisInx.positionName ||"";
                            hisInx.unitName = hisInx.unitName ||"";
                            hisVar = hisVar +"<tr><td>"+hisInx.assigneeName +"</td><td>"+hisInx.positionName+"</td><td>"+hisInx.unitName+"</td><td>"+apprvText+"</td><td>"+ hisInx.endTime+"</td></tr>";
                        }
                        context = context + hisVar ;
                    }
                    if(index.forecast){
                        /* context = context +"<strong style='font-size: 16px'>审批预测</strong>"+"<br/> <table >"+
                         "<tr><th>审批人</th><th>岗位名称</th><th>部门名称</th></tr>";*/
                        var forecast = index.forecast;
                        var str = "";
                        $.each(forecast, function(i,val) {
                            val.employeeCode = val.employeeCode || "";
                            val.positionName = val.positionName || "";
                            val.unitName = val.unitName || "";
                            str = str +"<tr><td>"+ val.name+"("+val.employeeCode+")" +"</td><td>"+val.positionName+"</td><td>"+val.unitName+"</td><td></td></td><td></tr>";
                        });
                        context = context + str ;
                    }
                    context = context +"</table>";
                    div.attr("title",context);
                    $("#processImg").append(div);
                }
            }
        }
        var dataSourceCC = new kendo.data.DataSource({
            data: []});
    </script>
        <div>
            <div class="approve-block">
                <h3>审批事项</h3>
                <table id="itemTable" class="approve-table">
                    <tr>
                        <td style="width: 170px;" class="item-label">流程名称</td>
                        <td colspan="3" class="item-value" id="td-workflow-name"></td>
                    </tr>
                    <tr>
                        <td style="width: 170px;" class="item-label">流程ID</td>
                        <td style="width: 250px;" class="item-value" id="td-processNum"></td>
                        <td style="width: 170px;" class="item-label">申请人</td>
                        <td style="width: 250px;" id="td-startUserName" class="item-value"></td>
                    </tr>
                    <tr>
                        <td style="width: 170px;" class="item-label">申请时间</td>
                        <td style="width: 250px;" id="td-startTime" class="item-value"></td>
                        <td style="width: 170px;" class="item-label">优先级</td>
                        <td style="width: 250px;" id="td-priority" class="item-value"></td>
                    </tr>
                    <tr>
                        <td style="width: 170px;" class="item-label">流程描述</td>
                        <td colspan="3" class="item-value" id="td-workflow-description"></td>
                    </tr>
                </table>
            </div>

            <div class="approve-block">
                <h3>审批表单</h3>
                <iframe id="includeFrame" style="width:100%" name="includeFrame" onLoad="onIncludeFrameLoad()"></iframe>
            </div>



            <div class="approve-block" id = "tabs">
                <ul id="hisTab" class="nav nav-tabs">
                    <li class="active">
                        <a href="#historyDetail" data-toggle="tab" >
                            <h3>审批历史</h3>
                        </a>
                    </li>
                    <li><a href="#processImg" data-toggle="tab" id="proImg">
                            <h3>流程图</h3>
                        </a>
                    </li>
                </ul>
                <div id="hisTabContent" class="tab-content ">
                    <div class="tab-pane fade in active" id="historyDetail" >
                        <table id="historyTable" class="approve-table">
                            <thead>
                            <tr>
                                <td style="width: 170px;">审批时间</td>
                                <td style="width: 250px;">审批环节</td>
                                <td style="width: 150px;">审批人</td>
                                <td style="width: 150px;">审批动作</td>
                                <td>审批意见</td>
                            </tr>
                            </thead>
                            <tbody id="historyTableBody" style="max-height: 100px;overflow: scroll;"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="processImg">
                        <embed id="svg" type="image/svg+xml" onload="onSvgLoad()"
                               src="${base.contextPath}/wfl/runtime/process-instances/${RequestParameters.processInstanceId}/diagram"/>
                    </div>
                </div>
            </div>


            <div class="approve-block">
                <h3>审批意见</h3>
                <textarea id="ta-comment" ></textarea>
               <!-- <div><span>您还可以输入</span><span id="wordLeft" style="margin:0 5px 0 5px">300</span><span>个字!</span></div>-->
                <!--<script>
                    var maxWords = 300;
                    $('#ta-comment').on('input', function (e) {
                        var left = maxWords - (e.target.value || '').length
                        $('#wordLeft').text(left);
                        if (left <= 10) {
                            $('#wordLeft').addClass('comment-too-long')
                        } else {
                            $('#wordLeft').removeClass('comment-too-long')
                        }
                    });
                </script>-->
            </div>

            <div class="approve-block" style="height: 40px;display: flex;align-items: baseline">
                <div style="float: left;"><h3>抄送</h3></div>
                <div style="float: left;padding-left: 24px"><a href="javascript:carbonCopy()">添加</a></div>
                <div style="clear:both;"></div>
            </div>
            <div class="listViewBorder">

                <div id="carbonCopy"></div>
                <!-- <h4>抄送给</h4>-->
                <div style="clear: both"></div>
                <script>
                    $("#carbonCopy").kendoListView({
                        dataSource: dataSourceCC,
                        template: '<div style="" class="listView" >#:employeeName#  <a href="javascript:void(0)" onclick="removeEmp(this)"><i class="fa fa-times" aria-hidden="true"></i></a> </div>',
                    });
                </script>
            </div>


            <div class="approve-block" style="height:40px;">
                <button id='btn-approved' type="button" class="btn btn-success" style="display: none">
                    <span class="fa fa-check-circle"></span><span id='text-approved'>同意</span>
                </button>
                <button id='btn-rejected' type="button" class="btn btn-warning" style="display: none">
                    <span class="fa fa-times-circle"></span><span id='text-rejected'>拒绝</span>
                </button>
                <div id="custom-btn-container" style="display: inline-block;">
                    <!--custom buttons-->
                </div>
                <button id="btn-delegate" type="button" class="btn btn-primary" style="display: none">
                    <span class="fa fa-arrow-circle-right"></span><span id='text-delegate' >转交</span>
                </button>
                <button id="btn-add-approver" type="button" class="btn btn-info" style="display: none">
                    <span class="fa fa-user-plus"></span><span id='text-add-approver' >添加审批人</span>
                </button>
                <!--<button id='btn-carbonCopy' type="button" class="btn btn-default" >
                    <span class="fa fa-reply"></span><span id='text-carbonCopy'>抄送</span>
                </button>-->
                <!--<button id="btn-jumpto" type="button" class="btn btn-info">
                    <span class="fa fa-paper-plane"></span><span id='text-jumpto'>跳转至</span>
                </button>-->
            </div>




            <script type="text/javascript">
                var viewModel = kendo.observable({
                    model: {
                        enabledFlag:'Y',
                        isList:[],
                    },
                    queryResource: function (e) {
                        $('#employeeGrid').data('kendoGrid').dataSource.page(1);
                    }
                });
            </script>
            <div id="jumpDialog" style="display:none">

                <input type="text" id="jumpTarget">
                <button id="btn-jump" type="button" class="btn btn-info" onclick="jump()">
                    <span class="fa fa-paper-plane"></span><span id='text-jump'>跳转</span>
                </button>
            </div>

            <div id="selectEmp" style="display:none">
                <div class="panel">
                    <form class="form-horizontal" id="query-form">
                        <div class="panel-body">

                            <div class="col-xs-5">
                                <div class="form-group">
                                    <label class="col-xs-3 control-label"><@spring.message "hrorgunit.name"/></label>
                                    <div class="col-xs-9">
                                        <input type="text" id="unitName" data-bind="value:model.unitId,text:model.unitName" style="width: 100%"
                                        >
                                        <script>
                                            $("#unitName").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "LOV_UNIT")}));

                                            kendo.bind($('#unitName'), viewModel);
                                        </script>


                                    </div>
                                </div>
                            </div>

                            <div class="col-xs-5">
                                <div class="form-group">
                                    <label class="col-xs-3 control-label"><@spring.message "position.name"/></label>
                                    <div class="col-xs-9">
                                        <input type="text" id="positionName" data-bind="value:model.positionId,text:model.positionName" style="width: 100%">
                                        <script>
                                            $("#positionName").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "LOV_POSITION")},
                                                {
                                                    query: function (e) {

                                                        var var1 = viewModel.model.unitId;
                                                        if (var1) {
                                                            e.param['unitId'] = var1;
                                                        }
                                                    }
                                                }));

                                            kendo.bind($('#positionName'), viewModel);
                                        </script>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xs-5">
                                <div class="form-group">
                                    <label class="col-xs-3 control-label"><@spring.message "employee.employeeCode"/></label>
                                    <div class="col-xs-9">
                                        <input type="text" id="employeeCode" style="width: 100%" data-bind="value:model.employeeCode"
                                               class="k-textbox">
                                        <script>kendo.bind($('#employeeCode'), viewModel);</script>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xs-5">
                                <div class="form-group">
                                    <label class="col-xs-3 control-label"><@spring.message "employee.name"/></label>
                                    <div class="col-xs-9">
                                        <input type="text" id="name" style="width: 100%" data-bind="value:model.name"
                                               class="k-textbox">
                                        <script>kendo.bind($('#name'), viewModel);</script>
                                    </div>
                                </div>
                            </div>


                            <div class="col-xs-2">
                                <div class="form-group">
                                    <div class="col-xs-5">
                                      <span class="btn btn-primary" id="query" data-bind="click:queryResource"
                                            type="submit"><i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
                                        <script>kendo.bind($('#query'), viewModel);</script>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <!-- end panel-->
                    </form>
                </div>
                <div id="employeeGridDiv" style="clear:both;height:300px">
                    <div id="employeeGrid"></div>
                </div>
                <div id = "employeeGridForCCDiv"style="clear:both;height:300px" >
                    <div id="employeeGridForCC"></div>
                </div>
            </div>


            <div id="processStateWin" style="display: none;">
                <embed id="svg1" type="image/svg+xml"></embed>
            </div>

        </div>
    </div>


    <script type="text/javascript">


        $("#employeeGridForCCDiv").hide();
        $("#employeeGridDiv").hide();

        var contextPath_ = '${base.contextPath}';
        var currentTaskId = '${RequestParameters.taskId!taskId}';
        var currentTaskInfo = {};
        var executionVariables = {};
        var isAddSign = false;
        //var iscarbonCopy = false;

        function closeCurrentWin() {
            if (window.top.closeTab) {
                reQueryTaskListTab();
                window.top.closeTab('PROCESS_TASK_' +　currentTaskId);
                return;
            }
            window.close();
        }

        function reQueryTaskListTab() {
            var mainTab = window.top.$("#mainTab").data("kendoTabStrip");
            var idx = jQuery.inArray('WFL_TASK', mainTab.tabids);
            var WFL_TASK = mainTab.contentElements[idx];
            if(WFL_TASK){
                var iframe = $(WFL_TASK).find('iframe')[0];
                iframe.contentWindow.doQuery();
            }
            idx = jQuery.inArray('WFL_MY_TASK', mainTab.tabids);
            var WFL_MY_TASK = mainTab.contentElements[idx];
            if(WFL_MY_TASK){
                var iframe = $(WFL_MY_TASK).find('iframe')[0];
                iframe.contentWindow.doQuery();
            }
        }

        $.ajax({
            url: contextPath_ + '/wfl/runtime/<#if isAdmin!false>admin/</#if>tasks/' + currentTaskId + '/details',
            success: function (result) {
                if (result.success === false) {
                    kendo.ui.showErrorDialog({
                        title: $l('hap.error'),
                        message: result.message
                    }).done(function () {
                        closeCurrentWin();
                    });
                    return;
                }
                result.createTime = result.createTime || ''
                result.dueTime = result.dueTime || '无'
                currentTaskInfo = result;
                $.each(currentTaskInfo.executionVariables || [], function (i, r) {
                    executionVariables[r.name] = r.value;
                });

                updateApproveButton();


                $("#td-description").text(result.description || '');
                $('#td-processNum').text(result.processInstance.id || '');
                var startUserName = result.processInstance.startUserName || '';
                if(result.processInstance.startUserId){
                    startUserName = startUserName + '(' +result.processInstance.startUserId +')';
                }
                $('#td-startUserName').text(startUserName);
                $('#td-workflow-name').text(result.processInstance.processDefinitionName || '');
                $("#td-priority").text(readablePriority(result.priority) ||'');
                $("#td-startTime").text(result.processInstance.startTime ||'');
                $("#td-dueTime").text(result.dueTime ||'');
                $("#td-workflow-description").text(result.description ||'');


                $("#td-assignee").text(result.assigneeName || '');
                //updateAssigneeName();


                //createApproveProgress(result.historicTaskList)
                createHistoricTable(result.historicTaskList);
                if (result.formKey) {
                    var formKey = currentTaskInfo.formKey;
                    if(formKey.indexOf('?')>0){
                        formKey = formKey+'&businessKey='+result.processInstance.businessKey;
                    }else {
                        formKey = formKey+'?businessKey=' + result.processInstance.businessKey;
                    }
                    document.getElementById('includeFrame').src = (contextPath_ + '/' + formKey)
                }
                isAddSign =false;
            }
        })


        function viewProcessState() {
            document.getElementById("svg1").src = "${base.contextPath}/wfl/runtime/process-instances/" + currentTaskInfo.processInstanceId + "/diagram?__r=" + Math.random();

            $('#processStateWin').kendoWindow({
                width: "800px",
                height: "550px",
                title: "流程审批状态图",
                modal: true,
                visible: false,
                actions: [
                    "Pin",
                    "Maximize",
                    "Close"
                ]
            }).data("kendoWindow").center().open().pin();

        }

        function updateApproveButton() {
            /*  if (currentTaskInfo.delegationState == 'pending') {
             $('#div-resolve').show();
             $('#btn-approved').attr({"disabled": "disabled"});
             $('#btn-rejected').attr({"disabled": "disabled"});
             }*/
            if ('pending' == currentTaskInfo.delegationState){
                $('#btn-add-approver').attr({"disabled": "disabled"});
            }else if('resolved' == currentTaskInfo.delegationState){
                $('#btn-add-approver').attr({"disabled": "disabled"});
            }
            var hasSetApproveResult = false;
            $.each(currentTaskInfo.formData.formProperties, function (i, r) {
                if (r.id == 'approveResult' && r.type == 'enum') {
                    var findApproved = false, findReject = false;
                    hasSetApproveResult = true;
                    $.each(r.enumValues, function (ii, rr) {
                        if (rr.id == 'APPROVED' && rr.name) {
                            findApproved = true;
                            $('#text-approved').text($l(rr.name))
                        } else if (rr.id == 'REJECTED' && rr.name) {
                            findReject = true;
                            $('#text-rejected').text($l(rr.name))
                        } else {
                            // custom button
                            var cb0 = $("<button/>").attr({
                                'id': 'btn-custom-' + rr.id,
                                'type': "button",
                                'class': "btn btn-default",
                                'action': rr.id
                            });
                            cb0.text(rr.name);
                            $('#custom-btn-container').append(cb0);
                            cb0.click(function () {
                                customApproveAction(rr.id);
                            });
                        }
                    });
                    if (findApproved) {
                        $('#btn-approved').show();
                    }
                    if (findReject) {
                        $('#btn-rejected').show();
                    }
                }
                //ADD_SIGN DELEGATE
                if (r.id == 'APPROVAL_ACTION' && r.type == 'enum') {
                    $.each(r.enumValues, function (ii, rr) {
                        if (rr.id == 'DELEGATE_FLAG' && rr.name) {
                            if(rr.name == 'Y'){
                                $('#btn-delegate').show();
                            }
                        }else if(rr.id == 'ADD_SIGN_FLAG' && rr.name){
                            if(rr.name == 'Y'){
                                $('#btn-add-approver').show();
                            }
                        }
                    });
                }
            })
            if( !hasSetApproveResult){
                $('#btn-approved').show();
                $('#btn-rejected').show();
            }
            if(parent.autoResizeIframe){
                parent.autoResizeIframe(_currentFunctionCode)
            }
        }


        function updateAssigneeName() {
            if (currentTaskInfo.delegationState == 'pending') {
                $("#delegation-mark").text("(转交待确认)");
            } else if (currentTaskInfo.delegationState == 'resolved') {
                $("#delegation-mark").text("(已转交)");
            } else {
                $("#delegation-mark").remove()
            }

            if (currentTaskInfo.taskDelegate) {
                $('#delegation-detail').text(currentTaskInfo.taskDelegate.fromUserName)
            }
        }


        function readablePriority(p) {
            p = p || 0;
            if (p < 33)
                return '低';
            if (p < 66)
                return '中';
            return '高'
        }

        function createHistoricTable(result) {
            var tb = $("#historyTableBody");
            result = result || [];
            var apprvText = ''
            $.each(result, function (i, r) {
                var tr = WFL.ce('tr', tb);
                WFL.ce('td', tr).text(r.endTime);
                WFL.ce('td', tr).text(r.name);
                WFL.ce('td', tr).text(r.assigneeName || r.assignee || '');


                if (r.action == 'APPROVED'){
                    apprvText = "<span class='action_ok'>同意</span>";
                } else if (r.action == 'REJECTED'){
                    apprvText = "<span class='action_dangerous'>拒绝</span>";
                }else if(r.action == 'ADD_SIGN'){
                    apprvText = "<span class='action_dangerous'>加签</span>";
                }else if(r.action == 'DELEGATE'){
                    apprvText = "<span class='action_dangerous'>转交</span>";
                } else if(r.action == 'JUMP'){
                    apprvText = "<span class='action_dangerous'>跳转</span>";
                }else if(r.action == 'RECALL'){
                    apprvText = "<span class='action_dangerous'>撤回</span>";
                }else if(r.action == "AUTO_DELEGATE") {
                    apprvText = "<span class='action_dangerous'>自动转交</span>";
                }else if(r.action == "CARBON_COPY") {
                    apprvText = "<span class='action_dangerous'>抄送</span>";
                }else{
                    apprvText = r.action || ''
                }


                WFL.ce('td', tr).html(apprvText);
                WFL.ce('td', tr).text(r.comment || '');
            });
        }

        //
        //    function createApproveProgress(result) {
        //        var prog = document.getElementById('approve-progress');
        //        createDot(prog, {
        //            name: '开始',
        //            startTime: currentTaskInfo.processInstance.startTime,
        //            assignee: currentTaskInfo.processInstance.startUserId,
        //            assigneeName: currentTaskInfo.processInstance.startUserName
        //
        //        })
        //        $.each(result, function (i, r) {
        //            createDot(prog, r)
        //        });
        //        var current = ce('div', prog, {'class': 'not_complete'});
        //        ce('div', current, {'class': 'dot-name'}).innerText = currentTaskInfo.name;
        //        ce('div', current, {'class': 'dot-time'}).innerText = Hap.formatDateTime(currentTaskInfo.createTime);
        //        ce('div', current, {'class': 'dot-assign'}).innerText = currentTaskInfo.assigneeName || currentTaskInfo.assignee;
        //    }
        //
        //    function createDot(p, r) {
        //        var his = ce('div', p, {'class': 'complete'});
        //        ce('div', his, {'class': 'dot-name'}).innerText = r.name;
        //        ce('div', his, {'class': 'dot-time'}).innerText = Hap.formatDateTime(r.endTime || r.startTime);
        //        ce('div', his, {'class': 'dot-assign'}).innerText = r.assigneeName || r.assignee;
        //    }



        $('#btn-resolve').click(function () {
            kendo.ui.showConfirmDialog({
                title: $l('hap.confirm'),
                message: '确认这个转交的任务？'
            }).done(function (e) {
                if (e.button == 'OK') {
                    taskAction({
                        action: 'resolve',
                        callback: function () {
                            currentTaskInfo.delegationState = 'resolved';
                            updateAssigneeName();
                            $('#div-resolve').remove();
                            $('#btn-approved').attr({"disabled": null})
                            $('#btn-rejected').attr({"disabled": null})
                        }
                    });
                }
            })
        });


        $('#btn-approved').click(function () {
            kendo.ui.showConfirmDialog({
                title: $l('hap.confirm'),
                message: $l('hap.confirm') + '<span class="action_ok">' + $('#text-approved').text() + '</span>？'
            }).done(function (e) {
                if (e.button == 'OK') {
                    taskAction({approveResult: 'APPROVED'});
                }
            })
        });

        $('#btn-rejected').click(function () {
            kendo.ui.showConfirmDialog({
                title: $l('hap.confirm'),
                message: $l('hap.confirm') + '<span class="action_dangerous">' + $('#text-rejected').text() + '</span>？'
            }).done(function (e) {
                if (e.button == 'OK') {
                    taskAction({approveResult: 'REJECTED'});
                }
            })
        });

        function customApproveAction(actionId) {
            var cb0 = $('#btn-custom-' + actionId);
            kendo.ui.showConfirmDialog({
                title: $l('hap.confirm'),
                message: $l('hap.confirm') + '<span class="action_custom">' + cb0.text() + '</span>？'
            }).done(function (e) {
                if (e.button == 'OK') {
                    taskAction({approveResult: actionId});
                }
            })
        }


        $('#query-form input').keydown(function (e) {
            if (e.keyCode == 13) {
                e.target.blur();
                viewModel.queryResource(e);
            }
        });

        $('#employeeGrid').dblclick(function (e) {
            selectDelegateEmployee();
        });

        function selectDelegateEmployees() {

            var selection = employeeGridForCC.selectedDataItems();
            var data = dataSourceCC.data();
            for(var i =0 ;i < selection.length; i++){
                var empData = {};
                empData["employeeCode"] = selection[i].employeeCode;
                empData["id"] = selection[i].employeeId;
                empData["employeeName"] = selection[i].name+' ('+selection[i].employeeCode+')';
                data.push(empData);
                //dataSourceCC.pushUpdate(empData);
            }
            //去重
            var res = [];
            var json = {};
            for(var i = 0; i < data.length; i++){
                if(!json[data[i].id]){
                    res.push(data[i]);
                    json[data[i].id] = 1;
                }
            }
            dataSourceCC.data(res);
            closeWin();
            //dataSourceCC.data(data);

            /*    if(selection.length == 0){
             return;
             }
             taskAction({action:'carbonCopy',targetUser:data});*/

        }

        function selectDelegateEmployee() {
            var row = employeeGrid.select();
            var data = employeeGrid.dataItem(row);
            closeWin();

            var targetUser = data.employeeCode
            if (!targetUser)
                return;
            if(isAddSign){
                taskAction({action: 'addSign', targetUser: targetUser});
            }else{
                taskAction({action: 'delegate', targetUser: targetUser});
            }
        }

        function closeWin() {
            $("#selectEmp").data("kendoWindow").close();
        }
        var dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "${base.contextPath}/hr/employee/queryAll",
                    type: "POST",
                    traditional:true,
                    dataType: "json"
                },
                parameterMap: function (options) {
                    if(dataSourceCC._data){
                        var idLists = [];
                        dataSourceCC._data.map(function (i,v) {
                            idLists.push(i.id);
                        })
                        viewModel.model.set('idList',idLists);
                    }
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "employeeId",
                    fields: {
                        employeeCode: {type: "string"},
                        name: {type: "string"},
                        unitName: {type: "string"},
                        positionName: {type: "string"}
                    }
                }
            }

        });

        var employeeGrid = $("#employeeGrid").kendoGrid({
            dataSource: dataSource,
            height: '100%',
            autoBind:false,
            navigatable: true,
            resizable: false,
            scrollable: true,
            editable: false,
            selectable: 'row',
            pageable: {
                pageSizes: [5, 10, 20, 50],
                refresh: true,
                buttonCount: 5
            },
            toolbar: [
                {
                    template: '<span class="btn btn-success" onclick="selectDelegateEmployee()"><i class="fa fa-check-circle" style="margin-right:3px;"></i><@spring.message "hap.ok"/></span>'
                }, {
                    template: '<span class="btn btn-default" onclick="closeWin()"><i class="fa fa-undo" style="margin-right:3px;"></i><@spring.message "hap.cancel"/></span>'
                }
            ],
            columns: [
                {
                    field: "employeeCode",
                    title: '<@spring.message "employee.employeeCode"/>',
                    width: 120
                }, {
                    field: "name",
                    title: '<@spring.message "employee.name"/>',
                    width: 120
                },
                {
                    field: "unitName",
                    title: '<@spring.message "hrorgunit.name"/>',
                    width: 120
                }, {
                    field: "positionName",
                    title: '<@spring.message "position.name"/>',
                    width: 120
                }
            ],
            dataBound: function (e) {
                $("#employeeGrid").data('kendoGrid').resize();
            }
        }).data("kendoGrid");

        var employeeGridForCC = $("#employeeGridForCC").kendoGrid({
            dataSource: dataSource,
            height: '100%',
            navigatable: true,
            autoBind:false,
            resizable: false,
            scrollable: true,
            editable: false,
            selectable: 'multiple, rowbox',
            pageable: {
                pageSizes: [5, 10, 20, 50],
                refresh: true,
                buttonCount: 5
            },
            toolbar: [
                {
                    template: '<span class="btn btn-success" onclick="selectDelegateEmployees()"><i class="fa fa-check-circle" style="margin-right:3px;"></i><@spring.message "hap.ok"/></span>'
                }, {
                    template: '<span class="btn btn-default" onclick="closeWin()"><i class="fa fa-undo" style="margin-right:3px;"></i><@spring.message "hap.cancel"/></span>'
                }
            ],
            columns: [
                {
                    field: "employeeCode",
                    title: '<@spring.message "employee.employeeCode"/>',
                    width: 120
                }, {
                    field: "name",
                    title: '<@spring.message "employee.name"/>',
                    width: 120
                },
                {
                    field: "unitName",
                    title: '<@spring.message "hrorgunit.name"/>',
                    width: 120
                }, {
                    field: "positionName",
                    title: '<@spring.message "position.name"/>',
                    width: 120
                }
            ],
            dataBound: function (e) {
                $("#employeeGrid").data('kendoGrid').resize();
            }
        }).data("kendoGrid");

        $('#btn-delegate').click(function () {
            //弹出选择员工页面
            $("#employeeGridForCCDiv").hide();
            $("#employeeGridDiv").show();
            var selectEmp = $("#selectEmp").kendoWindow({
                actions: ["Close"],
                width: 800,
                height: 500,
                title: '选择员工',
                modal: true,
                resizable: false,
                open: function () {
                    $('#employeeGrid').data('kendoGrid').dataSource.page(1);
                }
            }).data("kendoWindow");
            selectEmp.center().open();
        });

        var carbonCopy = function () {
            //弹出选择员工页面
            $("#employeeGridForCCDiv").show();
            $("#employeeGridDiv").hide();
            var selectEmp = $("#selectEmp").kendoWindow({
                actions: ["Close"],
                width: 800,
                height: 500,
                title: '选择员工',
                modal: true,
                resizable: false,
                draggable: true,
                open: function () {
                    //iscarbonCopy = true;
                    $('#employeeGridForCC').data('kendoGrid').dataSource.page(1);
                }
            }).data("kendoWindow");
            //selectEmp.center().open();
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}', 1000, function () {
                    selectEmp.center().open();
                })
            }else {
                selectEmp.center().open();
            }
        };

        var removeEmp = function(e){
            var listView = $("#carbonCopy").data("kendoListView");
            listView.remove($(e.parentNode));
        }

        $('#btn-add-approver').click(function () {
            $("#employeeGridForCCDiv").hide();
            $("#employeeGridDiv").show();
            var selectEmp = $("#selectEmp").kendoWindow({
                actions: ["Close"],
                width: 800,
                height: 500,
                title: '选择员工',
                modal: true,
                resizable: false,
                open: function () {
                    isAddSign = true;
                    $('#employeeGrid').data('kendoGrid').dataSource.page(1);
                }
            }).data("kendoWindow");
            selectEmp.center().open();
        });

        function taskAction(p) {
            if(includeFrame.executeWorkFlowTask){
                includeFrame.executeWorkFlowTask(actionCallBack,p);
            }else{
                actionCallBack(p);
            }
        }

        function actionCallBack(p) {
            p = p || {};
            p.action = p.action || 'complete'
            if('pending' == currentTaskInfo.delegationState && 'delegate'!=p.action){
                p.action = 'resolve'
            }
            var variables = [];
            if (p.action != 'delegate') {
                var formVars = {};
                if (includeFrame.getFormProperties) {
                    formVars = includeFrame.getFormProperties() || {};
                }

                //TODO 必输内容校验；仅传递定义过的属性
                formVars.approveResult = p.approveResult;
                formVars.comment = $("#ta-comment").val();
                $.each(formVars, function (k, v) {
                    variables.push({name: k, value: v});
                })
            }

            var carbonCopyUsers = "";
            var usersDate = dataSourceCC.data();
            for(var i = 0 ;i<usersDate.length;i++){
                if(i == 0){
                    carbonCopyUsers = usersDate[i].employeeCode;
                }else{
                    carbonCopyUsers = carbonCopyUsers + ","+ usersDate[i].employeeCode;
                }
            }

            var param = {
                assignee: p.targetUser || null,
                action: p.action,
                comment: $("#ta-comment").val(),
                variables: variables,
                jumpTarget: p.jumpTarget || null,
                carbonCopyUsers : carbonCopyUsers
            };

            Hap.blockUI();
            $.ajax({
                url: contextPath_ + '/wfl/runtime/<#if isAdmin!false>admin/</#if>tasks/' + currentTaskId,
                type: 'POST',
                contentType: 'application/json',
                data: kendo.stringify(param),
                success: function (args) {
                    if (args.success === false) {
                        kendo.ui.showErrorDialog({
                            title: $l('hap.error'),
                            message: args.message
                        });
                    } else {
                        if (p.callback) {
                            p.callback(args);
                        } else {
                            kendo.ui.showInfoDialog({
                                title: $l('hap.tip.info'),
                                message: '操作完成!'
                            }).done(function () {
                                closeCurrentWin()
                            });
                        }
                    }
                }, error: function (args) {
                    kendo.ui.showInfoDialog({
                        title: $l('hap.error'),
                        message: kendo.stringify(args)
                    });
                },
                complete:function () {
                    Hap.unblockUI();
                }
            })
        }

        $('#btn-jumpto').click(function (){
            var jumpDialog = $("#jumpDialog").kendoWindow({
                actions: ["Close"],
                width: 900,
                height: 450,
                title: '跳转',
                visible: false,
                resizable: false,
                modal: true,
                close: function () {

                }
            }).data("kendoWindow");
            jumpDialog.center().open();
        })
        var jump = function(){
            var jumpTarget =  $("#jumpTarget").val();
            taskAction({action: 'jump', jumpTarget: jumpTarget});

        }
    </script>
    <style type="text/css">

        .priority-median {
            background-color: yellowgreen;
        }

        .priority-high {
            background-color: orange;
        }

    </style>
    </body>
    </html>
